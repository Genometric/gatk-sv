name: Test Action

on:
  push:
    branches:
      - main
      - VJalili-patch-31
    paths:
      - 'src/**'
      - 'dockerfiles/**'
      - 'scripts/docker/build_docker.py'
      - '.github/workflows/test_action.yml'
  pull_request:
    branches:
      - main
      - VJalili-patch-31
    paths:
      - 'src/**'
      - 'dockerfiles/**'
      - 'scripts/docker/build_docker.py'
      - '.github/workflows/test_action.yml'

env:
  AZURE_STORAGE_ACCOUNT_NAME: 'cromwell7379410456f0'
  AZURE_STORAGE_CONTAINER_NAME: 'workflows'
  AZURE_STORAGE_INPUTS_CONTAINER_NAME: 'tests-inputs'
  WORKFLOW_PATH: "./HelloWorld.wdl"
  WORKFLOW_INPUTS_PATH: "./HelloWorldInputs.json"
  WORKFLOW_DEPENDENCIES_PATH: "./Dependencies.zip"

permissions:
  id-token: write
  contents: write

jobs:
  build_args_job:
    runs-on: ubuntu-latest
    environment: Tests
    name: TEST RUN
    env:
      GITHUB_CONTEXT: ${{ toJson(github) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: 'Az CLI login'
        uses: azure/login@v2
        with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: TEST
        run: | 
          pwd
          ls
            
      - name: Submit workflow
        id: submit
        uses: Genometric/hello-world-javascript-action@v0.7
        with:
          azure_storage_account_name: ${{ env.AZURE_STORAGE_ACCOUNT_NAME }}
          azure_storage_container_name: ${{ env.AZURE_STORAGE_CONTAINER_NAME }}
          azure_storage_inputs_container_name: ${{ env.AZURE_STORAGE_INPUTS_CONTAINER_NAME }}
          workflow_path: ${{ env.WORKFLOW_PATH }}
          workflow_inputs_path: ${{ env.WORKFLOW_INPUTS_PATH }}
          workflow_dependencies_path: ${{ env.WORKFLOW_DEPENDENCIES_PATH }}
          subcommand: "submit"
      - name: Monitor submission status
        id: monitor
        uses: Genometric/hello-world-javascript-action@v0.7
        with:
          azure_storage_account_name: ${{ env.AZURE_STORAGE_ACCOUNT_NAME }}
          azure_storage_container_name: ${{ env.AZURE_STORAGE_CONTAINER_NAME }}
          azure_storage_inputs_container_name: ${{ env.AZURE_STORAGE_INPUTS_CONTAINER_NAME }}
          workflow_path: ${{ env.WORKFLOW_PATH }}
          workflow_inputs_path: ${{ env.WORKFLOW_INPUTS_PATH }}
          workflow_dependencies_path: ${{ env.WORKFLOW_DEPENDENCIES_PATH }}
          workflow_id: ${{ steps.submit.outputs.workflowId }}
          subcommand: "monitor"
      - name: Get Metadata
        id: metadata
        uses: Genometric/hello-world-javascript-action@v0.7
        with:
          azure_storage_account_name: ${{ env.AZURE_STORAGE_ACCOUNT_NAME }}
          azure_storage_container_name: ${{ env.AZURE_STORAGE_CONTAINER_NAME }}
          azure_storage_inputs_container_name: ${{ env.AZURE_STORAGE_INPUTS_CONTAINER_NAME }}
          workflow_path: ${{ env.WORKFLOW_PATH }}
          workflow_inputs_path: ${{ env.WORKFLOW_INPUTS_PATH }}
          workflow_dependencies_path: ${{ env.WORKFLOW_DEPENDENCIES_PATH }}
          workflow_id: ${{ steps.submit.outputs.workflowId }}
          subcommand: "metadata"
      - name: Get the output time
        run: echo "The time was ${{ steps.hello.outputs.time }}"


